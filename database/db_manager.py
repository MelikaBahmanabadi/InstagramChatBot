import sqlite3
from pathlib import Path
from typing import List, Dict, Any
import config


class DatabaseManager:
    def __init__(self):
        self.db_path = config.DATABASE_PATH
        self.db_path.parent.mkdir(parents=True, exist_ok=True)
    
    def get_connection(self):
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        return conn
    
    def initialize_database(self):
        conn = self.get_connection()
        cursor = conn.cursor()
        
        cursor.execute('''
            CREATE TABLE IF NOT EXISTS products (
                id INTEGER PRIMARY KEY,
                name TEXT,
                description TEXT,
                price REAL
            )
        ''')
        
        cursor.execute('SELECT COUNT(*) as count FROM products')
        count = cursor.fetchone()['count']
        
        if count == 0:
            self._seed_products(cursor)
        
        conn.commit()
        conn.close()
    
    def _seed_products(self, cursor):
        products = [
            ("گوشی سامسونگ Galaxy S23", "گوشی هوشمند پرچمدار سامسونگ با پردازنده قدرتمند و دوربین عالی", 28500000),
            ("گوشی اپل iPhone 15 Pro", "آیفون نسل جدید با تراشه A17 Pro و دوربین 48 مگاپیکسل", 52000000),
            ("گوشی شیائومی Redmi Note 13", "گوشی میان‌رده با باتری قوی و صفحه نمایش AMOLED", 8900000),
            ("لپ‌تاپ ایسوس VivoBook", "لپ‌تاپ 15 اینچی با پردازنده Core i5 و 8GB رم", 18500000),
            ("لپ‌تاپ لنوو ThinkPad", "لپ‌تاپ حرفه‌ای برای کسب و کار با کیفیت ساخت بالا", 32000000),
            ("تبلت سامسونگ Galaxy Tab S9", "تبلت اندروید با صفحه 11 اینچ و قلم S Pen", 21000000),
            ("هدفون سونی WH-1000XM5", "هدفون بی‌سیم با حذف نویز فعال و کیفیت صدای عالی", 14500000),
            ("ساعت هوشمند اپل Watch Series 9", "ساعت هوشمند با سنسورهای سلامتی پیشرفته", 19800000),
            ("کیبورد مکانیکی لاجیتک MX Keys", "کیبورد بی‌سیم حرفه‌ای با کلیدهای مکانیکی", 4200000),
            ("موس لاجیتک MX Master 3S", "موس ارگونومیک با دقت بالا و قابلیت اتصال چند دستگاه", 3800000),
            ("مانیتور ال‌جی UltraWide 34 اینچ", "مانیتور وایدسکرین با رزولوشن QHD و پنل IPS", 16500000),
            ("کیس گیمینگ ASUS ROG", "کیس کامپیوتر با سیستم خنک‌کننده پیشرفته و نورپردازی RGB", 5600000),
            ("پاور بانک انکر 20000mAh", "شارژر همراه با ظرفیت بالا و شارژ سریع", 1850000),
            ("کابل تایپ سی انکر", "کابل USB-C با قابلیت شارژ سریع و انتقال داده", 450000),
            ("شارژر دیواری شیائومی 67W", "شارژر سریع با پورت USB-C و USB-A", 980000),
            ("گوشی نوکیا G42", "گوشی اقتصادی با باتری 5000mAh و اندروید خالص", 6200000),
            ("گوشی وان‌پلاس 11", "گوشی پرچمدار با شارژ سریع 100W و صفحه 120Hz", 24500000),
            ("گوشی هواوی P60 Pro", "گوشی با دوربین حرفه‌ای و طراحی زیبا", 31000000),
            ("لپ‌تاپ اپل MacBook Air M2", "لپ‌تاپ نازک و سبک با تراشه M2 و عمر باتری عالی", 48000000),
            ("لپ‌تاپ HP Pavilion", "لپ‌تاپ همه‌کاره برای کار و سرگرمی", 22000000),
            ("تبلت اپل iPad Air", "تبلت با تراشه M1 و صفحه Liquid Retina", 28500000),
            ("تبلت لنوو Tab P11", "تبلت اندروید مقرون‌به‌صرفه با صفحه 11 اینچ", 8900000),
            ("هدفون بیتس Studio3", "هدفون بی‌سیم با صدای پرقدرت و طراحی شیک", 11200000),
            ("ایرپاد اپل AirPods Pro 2", "ایرپاد با حذف نویز و صدای فضایی", 10500000),
            ("اسپیکر JBL Charge 5", "اسپیکر بلوتوثی ضدآب با باتری قوی", 5400000),
            ("وب‌کم لاجیتک C920", "دوربین وب با کیفیت Full HD برای جلسات آنلاین", 2800000),
            ("میکروفون Blue Yeti", "میکروفون USB حرفه‌ای برای پادکست و استریم", 6700000),
            ("هارد اکسترنال سیگیت 2TB", "هارد دیسک قابل حمل با ظرفیت 2 ترابایت", 3200000),
            ("حافظه SSD سامسونگ 1TB", "حافظه جامد داخلی با سرعت خواندن بالا", 4500000),
            ("رم کینگستون 16GB DDR4", "رم کامپیوتر با فرکانس 3200MHz", 2100000),
            ("کارت گرافیک NVIDIA RTX 4060", "کارت گرافیک برای گیمینگ و کارهای گرافیکی", 18500000),
            ("مادربرد ASUS Prime", "مادربرد با چیپست B660 و پشتیبانی DDR5", 7800000),
            ("پردازنده Intel Core i7-13700", "پردازنده 16 هسته‌ای برای عملکرد بالا", 15200000),
            ("پردازنده AMD Ryzen 7 7700X", "پردازنده 8 هسته‌ای با معماری Zen 4", 14800000),
            ("خنک‌کننده پردازنده Cooler Master", "کولر مایع با رادیاتور 240mm", 4900000),
            ("کیس کامپیوتر NZXT H510", "کیس میدتاور با طراحی مینیمال", 3600000),
            ("روتر TP-Link Archer AX50", "روتر وای‌فای 6 با سرعت بالا", 2400000),
            ("سوئیچ شبکه Cisco 24 پورت", "سوئیچ گیگابیتی برای شبکه‌های کوچک", 5800000),
            ("دوربین کانن EOS R6", "دوربین میرورلس فول‌فریم با سنسور 20 مگاپیکسل", 95000000),
            ("لنز کانن RF 24-70mm", "لنز زوم استاندارد با دیافراگم f/2.8", 48000000),
            ("سه‌پایه مانفروتو", "سه‌پایه حرفه‌ای برای دوربین و فیلمبرداری", 8500000),
            ("فلاش گودکس V1", "فلاش اکسترنال با سر گرد و باتری لیتیومی", 6200000),
            ("استابلایزر DJI Ronin-S", "گیمبال سه محوره برای دوربین‌های DSLR", 21000000),
            ("درون DJI Mini 3 Pro", "پهپاد کوچک با دوربین 4K و زمان پرواز 34 دقیقه", 32000000),
            ("چاپگر اپسون L3250", "چاپگر جوهرافشان رنگی با سیستم تانک", 7800000),
            ("اسکنر کانن LiDE 400", "اسکنر تخت با رزولوشن 4800 DPI", 3400000),
            ("یو‌پی‌اس APC 1000VA", "منبع تغذیه بدون وقفه برای کامپیوتر", 4200000),
            ("کابل HDMI بلکین 2 متری", "کابل HDMI 2.1 با پشتیبانی 4K@120Hz", 680000),
            ("هاب USB-C هایپردرایو", "هاب 7 پورت با HDMI و کارتخوان", 1950000),
            ("گوشی گوگل Pixel 8", "گوشی با دوربین هوشمند و اندروید خالص", 29500000),
            ("گوشی موتورولا Edge 40", "گوشی با صفحه خمیده و شارژ بی‌سیم", 13800000),
            ("گوشی اوپو Find X6", "گوشی با دوربین Hasselblad و شارژ سریع", 27000000),
            ("گوشی ریلمی GT 3", "گوشی گیمینگ با پردازنده قدرتمند", 11500000),
            ("لپ‌تاپ دل XPS 15", "لپ‌تاپ پرمیوم با صفحه 4K و پردازنده i9", 68000000),
            ("لپ‌تاپ ایسر Aspire 5", "لپ‌تاپ مقرون‌به‌صرفه برای دانشجویان", 15800000),
            ("لپ‌تاپ MSI Gaming GF63", "لپ‌تاپ گیمینگ با کارت گرافیک RTX 4050", 35000000),
            ("تبلت مایکروسافت Surface Pro 9", "تبلت ویندوزی با کیبورد جداشونده", 42000000),
            ("کیندل پیپروایت آمازون", "کتابخوان الکترونیکی با صفحه 6.8 اینچ", 7200000),
            ("ساعت هوشمند سامسونگ Galaxy Watch 6", "ساعت اندرویدی با سنسور BioActive", 12500000),
            ("ساعت هوشمند گارمین Fenix 7", "ساعت ورزشی با GPS و عمر باتری طولانی", 24000000),
            ("مچ‌بند هوشمند شیائومی Band 8", "مچ‌بند ارزان با صفحه AMOLED", 1450000),
            ("هدفون گیمینگ HyperX Cloud II", "هدست با میکروفون و صدای محیطی 7.1", 3900000),
            ("کیبورد گیمینگ Razer BlackWidow", "کیبورد مکانیکی با کلیدهای سبز و RGB", 5200000),
            ("موس گیمینگ Logitech G502", "موس با سنسور HERO و وزن قابل تنظیم", 2800000),
            ("پد موس SteelSeries QcK", "پد موس گیمینگ با سطح پارچه‌ای", 650000),
            ("صندلی گیمینگ DXRacer", "صندلی ارگونومیک با پشتی قابل تنظیم", 12000000),
            ("میز گیمینگ Arozzi Arena", "میز بزرگ با سطح ضدآب و مدیریت کابل", 8500000),
            ("مانیتور گیمینگ ASUS TUF 27 اینچ", "مانیتور 165Hz با پنل IPS و G-Sync", 11200000),
            ("مانیتور دل UltraSharp 27 اینچ", "مانیتور 4K برای کارهای گرافیکی", 18500000),
            ("پروژکتور اپسون EB-X06", "ویدئو پروژکتور 3600 لومن برای ارائه", 14500000),
            ("تلویزیون سامسونگ QLED 55 اینچ", "تلویزیون هوشمند با فناوری Quantum Dot", 32000000),
            ("ساندبار سونی HT-S400", "سیستم صوتی 2.1 کانال با ساب‌ووفر", 8900000),
            ("گیرنده دیجیتال استارست", "گیرنده دیجیتال HD با پورت USB", 1200000),
            ("آنتن دیجیتال داخلی", "آنتن برای دریافت شبکه‌های دیجیتال", 450000),
            ("کنسول PlayStation 5", "کنسول بازی نسل نهم سونی", 28500000),
            ("کنسول Xbox Series X", "کنسول قدرتمند مایکروسافت", 26000000),
            ("کنسول Nintendo Switch OLED", "کنسول قابل حمل با صفحه OLED", 15800000),
            ("دسته بازی DualSense", "دسته بی‌سیم PS5 با فیدبک لمسی", 3200000),
            ("هدست واقعیت مجازی Meta Quest 3", "هدست VR مستقل با کنترلر", 24000000),
            ("دوربین مداربسته هایک‌ویژن", "دوربین IP با رزولوشن 4MP و دید در شب", 2800000),
            ("دزدگیر اماکن DSC", "سیستم اعلام سرقت با سنسورهای بی‌سیم", 6500000),
            ("آیفون تصویری کوماکس", "آیفون تصویری 7 اینچ با حافظه داخلی", 4200000),
            ("قفل دیجیتال سامسونگ", "قفل درب هوشمند با اثر انگشت و رمز", 9800000),
            ("سنسور دود و حریق", "سنسور هوشمند با اعلان به موبایل", 1850000),
            ("ترموستات هوشمند Nest", "ترموستات قابل برنامه‌ریزی برای گرمایش", 5600000),
            ("لامپ هوشمند فیلیپس Hue", "لامپ LED رنگی قابل کنترل با موبایل", 1450000),
            ("پریز هوشمند TP-Link", "پریز برقی قابل کنترل از راه دور", 680000),
            ("دوربین خودرو 70mai", "دوربین داشبوردی با ضبط 1080p", 2100000),
            ("جارو برقی رباتیک Roborock", "جاروبرقی هوشمند با نقشه‌برداری لیزری", 14500000),
            ("یخچال ساید‌بای‌ساید سامسونگ", "یخچال دو قلوی 30 فوت با یخساز", 48000000),
            ("ماشین لباسشویی ال‌جی 9 کیلو", "ماشین لباسشویی با موتور اینورتر", 18500000),
            ("ماشین ظرفشویی بوش", "ماشین ظرفشویی 14 نفره با مصرف کم آب", 24000000),
            ("اجاق گاز اخوان", "اجاق گاز 5 شعله با شیشه سکوریت", 12500000),
            ("مایکروویو سامسونگ", "مایکروویو 28 لیتری با گریل", 5400000),
            ("توستر فیلیپس", "توستر 2 اسلات با 7 سطح برشته‌کنی", 1950000),
            ("قهوه‌ساز دلونگی", "قهوه‌ساز اسپرسو با آسیاب داخلی", 18500000),
            ("آب‌میوه‌گیری مولینکس", "آبمیوه‌گیری 800 وات با دهانه بزرگ", 3200000),
            ("بلندر فیلیپس", "بلندر 1400 وات با کاسه شیشه‌ای", 4200000),
            ("جاروبرقی بوش", "جاروبرقی سطلی 2000 وات", 6800000),
            ("اتو بخار فیلیپس", "اتو بخار 2400 وات با کف سرامیکی", 2850000)
        ]
        
        cursor.executemany(
            'INSERT INTO products (name, description, price) VALUES (?, ?, ?)',
            products
        )
    
    def search_products(self, query: str, limit: int = 5) -> List[Dict[str, Any]]:
        conn = self.get_connection()
        cursor = conn.cursor()
        
        search_term = f"%{query}%"
        cursor.execute('''
            SELECT id, name, description, price 
            FROM products 
            WHERE name LIKE ? OR description LIKE ?
            LIMIT ?
        ''', (search_term, search_term, limit))
        
        results = [dict(row) for row in cursor.fetchall()]
        conn.close()
        return results

